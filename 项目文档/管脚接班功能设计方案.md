# “管脚接班”功能设计与实现方案

## 1. 背景与问题

在IC测试向量的编辑过程中，用户经常需要在“管脚设置”中修改一个向量表的管脚配置。一个典型的场景是“管脚接班”：当管脚数量达到上限时，用户通过取消一个旧管脚的勾选，并勾选一个新管脚，来让新管脚“接替”旧管脚的位置。

此时，一个核心问题随之产生：如何处理被接替的管脚列中已存在的成千上万行数据？

- **若直接修改元数据**：会导致新管脚名下显示旧管脚的“脏数据”，造成数据不一致和用户困惑。
- **若立即用默认值覆盖所有数据**：对于百万行级别的大表，这个覆写操作可能耗时数分钟，导致UI长时间冻结，严重影响用户体验。

本方案旨在解决这一矛盾，在保证UI响应速度和数据一致性之间取得最佳平衡。

## 2. 设计目标

- **响应性**：对于任何规模的数据表，用户的操作都应得到快速响应，避免程序“假死”。
- **一致性**：最终数据状态必须是清晰和一致的，避免“新瓶装旧酒”的数据混乱情况。
- **可控性**：对于耗时操作，应将最终决策权交给用户，并明确告知其不同选择的后果。
- **复用性**：最大程度地复用项目中已有的、经过充分测试的成熟功能，特别是“填充向量”功能，以降低实现复杂度和风险。

## 3. 核心方案：基于数据规模的自适应策略

我们不采用一刀切的僵化策略，而是根据向量表的行数，智能地选择不同的处理流程。

### 3.1 阈值定义

- **行数阈值**：**50,000行**
- **策略**：
  - 当向量表总行数 **小于** 50,000行时，执行“自动覆写”流程。
  - 当向量表总行数 **大于或等于** 50,000行时，执行“用户选择”流程。

### 3.2 小规模数据处理流程 (< 50,000行)

对于行数较少的表，数据覆写操作通常在几秒内即可完成，用户体感不强。因此，我们采用最直接、最能保证数据一致性的自动化流程。

1. **静默执行数据覆写**：
    - 在用户确认“管脚设置”后，程序将**自动、静默地调用现有的“填充向量”功能**。
    - 调用参数为：对被接替的管脚列，使用新管脚的默认值 'X'，填充所有行。
    - 由于“填充向量”功能已包含处理UI不假死的机制（如进度条），此操作不会阻塞UI。

2. **更新元数据**：
    - 在“填充向量”操作成功完成后，程序更新数据库中的元数据，将被接替管脚的列名等信息更改为新管脚的配置。

此流程对用户完全透明，在无感的情况下就保证了数据的绝对一致性。

### 3.3 大规模数据处理流程 (>= 50,000行)

对于大规模数据表，强制执行数据覆写会带来无法接受的等待时间。因此，我们将决策权交给用户。

1. **弹出选择对话框**：
    - 在用户确认“管脚设置”后，程序首先判断行数超过阈值，然后弹出一个确认对话框。

2. **提供明确选项**：
    - 对话框将提供两个选项，并清晰说明其后果：

    ---
    **标题**: 管脚数据处理方式选择

    **内容**:
    您正在修改的向量表包含超过 **50,000** 行数据。
    直接用新管脚的默认值 'X' 覆写所有旧数据会花费一些时间。请选择处理方式：

    ---

    **选项一 (推荐):**
    🔘 **覆写为默认值 'X' (慢，但数据一致)**
        *   此选项将调用“填充向量”功能，确保新管脚列下的数据是干净的。操作期间会显示进度条。

    ---

    **选项二:**
    🔘 **仅更新管脚名，保留旧数据 (快，但数据不一致)**
        *   **警告**: 此选项将立即完成操作，但新管脚列下会暂时显示旧管脚的数据。您需要稍后手动使用“填充向量”功能来清理数据。

    ---
    [ **确定** ] [ **取消** ]

3. **根据用户选择执行操作**：
    - **若用户选择“覆写为默认值”**：程序执行与小规模数据流程完全相同的操作，即调用“填充向量”功能，然后更新元数据。
    - **若用户选择“保留旧数据”**：程序将**跳过**所有数据覆写操作，**仅执行**元数据的更新。此时，操作瞬间完成，但用户需要明确知晓数据不一致的后果，并承担后续手动清理数据的责任。

## 4. 实现要点与代码复用

- **复用“填充向量”功能**：
  - 这是本方案的重中之重。我们**不编写任何新的、底层的二进制文件覆写逻辑**。
  - 所有的数据覆写任务，全部通过调用项目中**现有、稳定且高效的“填充向量”功能接口**来完成。
  - 这极大地降低了开发成本和风险，并天然地继承了“填充向量”功能已有的全部优点（如性能优化、进度反馈、UI防假死等）。

- **实现位置**：
  - 该逻辑的核心判断（行数检查、弹窗）应位于“管脚设置”对话框的“确定”按钮的槽函数，或者由该槽函数调用的`MainWindow`中的某个处理函数内。

- **涉及模块**：
  - `PinSettingsDialog`：发起管脚更改请求。
  - `MainWindow`：作为控制器，实现核心判断逻辑，调用后端功能。
  - `RobustVectorDataHandler`：提供现有的“填充向量”接口（如 `batchUpdateVectorColumn` 等）。

## 5. 总结

本方案是一个务实、灵活且健壮的设计。它通过一个简单的行数阈值，优雅地解决了不同数据规模下的用户体验问题。

- **对小数据**：追求自动化和强一致性，简化用户操作。
- **对大数据**：尊重用户的选择权和时间，提供灵活性。

最关键的是，本方案最大化地复用了项目中最核心、最成熟的“填充向量”功能，确保了新功能在实现上的低风险和高质量。
