# QCustomPlot波形图功能详细说明文档

## 一、基础架构与配置

### 1.1 波形图基本组件

- **主容器**: QDockWidget（m_waveformDock）可停靠、浮动、关闭
- **绘图组件**: QCustomPlot（m_waveformPlot）用于绘制波形
- **工具栏**: 包含管脚选择器、"全部"勾选框和刷新按钮
- **管脚选择器**: QComboBox（m_waveformPinSelector）
- **全部管脚勾选框**: QCheckBox（m_showAllPinsCheckBox）
- **值编辑器**: QLineEdit（m_waveformValueEditor）用于编辑波形点的值

### 1.2 波形图样式配置

- **窗口样式**:

  ```css
  QDockWidget {
     border: 1px solid #A0A0A0;
  }
  QDockWidget::title {
     background-color: #E1E1E1;
     padding-left: 5px;
     border-bottom: 1px solid #A0A0A0;
  }
  ```

- **容器样式**:

  ```css
  QWidget#waveformContainer {
      background-color: #F0F0F0;
      border: 1px solid #A0A0A0;
      margin: 0px;
  }
  ```

- **编辑器样式**:

  ```css
  QLineEdit { 
      border: 1px solid blue; 
      background-color: white; 
  }
  ```

### 1.3 坐标轴配置

- **X轴**: 表示行号，仅显示整数刻度
  - 标签: "行号"
  - 刻度间隔: 1.0
  - 数字格式: 固定点表示法（"f"）
  - 精度: 0（不显示小数位）
  - 子刻度: 关闭
- **Y轴**: 表示波形值，但隐藏刻度标签
  - 标签: "值"
  - 可见性: 隐藏刻度标签和子刻度

### 1.4 交互设置

- **允许的交互**:
  - 范围拖拽 (QCP::iRangeDrag)
  - 范围缩放 (QCP::iRangeZoom)
- **限制拖拽方向**: 仅水平方向（Qt::Horizontal）
- **限制缩放轴**: 仅X轴（允许水平缩放）
- **自定义上下文菜单**: 波形图支持右键菜单

## 二、管脚显示与配置

### 2.1 管脚数据获取

- 从两种视图获取管脚列信息:
  - **新视图**: 从m_vectorTableModel获取
  - **旧视图**: 从m_vectorTableWidget获取
- 仅显示类型为`Vector::ColumnDataType::PIN_STATE_ID`的列

### 2.2 管脚显示模式

- **单个管脚模式**: 仅显示当前从m_waveformPinSelector选择的管脚
- **全部管脚模式**: 当m_showAllPins为true时，显示所有管脚波形

### 2.3 管脚视觉配置

- **垂直间距**:
  - 每个管脚波形高度 (PIN_HEIGHT): 25.0
  - 管脚间隔 (PIN_GAP): 10.0
  - 单个波形实际高度 (WAVE_HEIGHT): 20.0
- **标签设置**:
  - 每个管脚左侧显示标签
  - 字体: Arial, 8pt
  - 背景: 半透明白色 (255, 255, 255, 180)
  - 边距: QMargins(2, 1, 2, 1)

### 2.4 管脚颜色分配

- **少于10个管脚时**: 使用预设颜色列表

  ```cpp
  QList<QColor> presetColors = {
      Qt::red, Qt::blue, Qt::green, Qt::magenta, Qt::cyan,
      QColor(255, 128, 0), // 橙色
      QColor(128, 0, 255), // 紫色
      QColor(0, 128, 128), // 青绿色
      QColor(128, 128, 0), // 橄榄色
      QColor(255, 0, 128)  // 粉红色
  };
  ```

- **超过10个管脚时**: 使用HSV色彩空间均匀分布颜色

  ```cpp
  pinColor = QColor::fromHsv(pinIndex * 360 / pinCount, 255, 255);
  ```

## 三、TimeSet与波形关系

### 3.1 TimeSet基本概念

- **TimeSet**: 定义波形的时序参数，存储在数据库表`timeset_list`和`timeset_settings`中
- **关键参数**:
  - 周期 (Period): 波形一个完整周期的时间，默认1000.0ns
  - T1R: 上升沿时间点，默认250.0ns
  - T1F: 下降沿时间点，默认750.0ns
  - 波形类型 (Wave ID): 波形模式，如NRZ(1), RZ(2), R0(3), SBC(4)

### 3.2 TimeSet数据获取

- **查询过程**:
  1. 首先从向量表第一行获取TimeSet ID
  2. 若失败，尝试从数据库直接查询
  3. 若仍失败，获取任何可用的TimeSet ID
- **周期获取**:

  ```sql
  SELECT period FROM timeset_list WHERE id = ?
  ```

- **T1R获取**:

  ```sql
  SELECT T1R FROM timeset_settings WHERE timeset_id = ? AND pin_id = ?
  ```

### 3.3 T1R区域显示

- **视觉效果**:
  - T1R区域显示为蓝色交叉填充样式
  - 颜色: QColor(0, 120, 255, 120)
  - 样式: Qt::DiagCrossPattern
- **T1R区域边界**:
  - 开始于X=0
  - 结束于X=T1R/Period（T1R占周期的比例）
- **T1R中间线**:
  - 灰色水平线，贯穿整个T1R区域
  - 从X=0开始，到X=T1R/Period结束
- **T1R过渡线**:
  - 从T1R区域末端的中间位置到第一个波形点的竖线
  - 使用灰色(Qt::gray)绘制
  - 线宽为1.0

### 3.4 波形偏移与对齐

- **每个管脚独立的T1R比例**: 根据各管脚在TimeSet中的T1R值计算
- **波形绘制偏移**: 使用T1R比例作为X轴偏移，确保所有管脚的波形边沿正确对齐
- **统一对齐机制**: 使用最大的T1R比例(m_currentXOffset)作为全局偏移基准

## 四、特殊波形类型

### 4.1 波形类型定义

- **NRZ (Non-Return to Zero, ID=1)**:
  - 默认波形类型
  - 在整个周期内保持高电平或低电平不变
  - 不需要特殊处理逻辑
- **RZ (Return to Zero, ID=2)**:
  - 在T1F时点将高电平信号返回到低电平
  - 在RZ模式中，高电平状态仅持续至T1F
- **R0 (Return to One, ID=3)**:
  - 在T1F时点将低电平信号返回到高电平
  - 在R0模式中，低电平状态仅持续至T1F
- **SBC (Surround By Complement, ID=4)**:
  - 信号值在T1R前后被其补码包围
  - 例如，1信号被0包围，0信号被1包围

### 4.2 波形类型应用逻辑

- **获取波形类型**:

  ```sql
  SELECT wave_id, T1F FROM timeset_settings 
  WHERE timeset_id = ? AND pin_id = ?
  ```

- **处理顺序**:
  1. 读取原始状态值（高/低电平）
  2. 清除原始图形数据点
  3. 根据波形类型生成特殊点集合(m_r0Points, m_rzPoints, m_sbcPoints)
  4. 调用专门的绘制函数处理每种波形类型

### 4.3 特殊波形样式

- **RZ波形**:
  - 使用蓝色实线绘制
  - 在T1F点处有一个向下的垂直线
  - 从T1F到周期末端保持低电平
  - 线宽：1.5
- **R0波形**:
  - 使用绿色实线绘制
  - 在T1F点处有一个向上的垂直线
  - 从T1F到周期末端保持高电平
  - 线宽：1.5
- **SBC波形**:
  - 使用紫色虚线绘制包围部分
  - 使用实线绘制中间部分
  - 线宽：1.0（包围部分），2.0（中间部分）

## 五、波形状态显示

### 5.1 基本状态绘制

- **'0'或'L'状态**: 绘制为低电平线(pinLowY)
- **'1'或'H'状态**: 绘制为高电平线(pinHighY)
- **'M'或'X'状态**: 绘制为中间电平线(pinMidY)
- **所有状态使用QCPGraph::lsStepLeft线型**, 确保数字信号的正确表现

### 5.2 特殊状态处理

- **'V'状态**:
  - 绘制为矩形框，无填充
  - 使用与管脚相同的颜色
  - 线宽：2.0
- **'X'状态**:
  - 在中间电平绘制灰色线
  - 若前一状态非中间电平，添加灰色过渡线
  - 线宽：1.5
- **'S'状态**: 无主线条，仅填充背景
- **字母状态填充**:
  - 偶数行: 蓝色交叉填充 (QColor(0, 0, 255, 70), Qt::DiagCrossPattern)
  - 奇数行: 紫色交叉填充 (QColor(128, 0, 128, 70), Qt::DiagCrossPattern)

### 5.3 状态转换绘制

- **状态转换线**:
  - 在状态变化处绘制垂直连线
  - 使用QCPGraph::lsStepLeft确保数字信号特性
  - 保持与主波形相同的颜色和线宽
- **特殊状态转换**:
  - 任何状态 → X: 灰色垂直过渡线
  - T1R区域 → 第一个波形点: 灰色垂直连线

## 六、交互功能

### 6.1 选择与高亮

- **点击选择**:
  - 左键点击波形点选中对应行和管脚
  - 高亮显示选中的波形点
  - 高亮样式:

    ```cpp
    highlightRect->setPen(QPen(Qt::blue, 2, Qt::DotLine));
    highlightRect->setBrush(QBrush(QColor(0, 0, 255, 30)));
    ```

  - 显示选中点的值

### 6.2 值编辑功能

- **双击编辑**:
  - 双击波形点显示编辑器
  - 编辑器限制输入一个字符
  - 有效输入: 0, 1, L, H, X, S, V, M
  - 编辑完成后自动更新波形图和表格数据

### 6.3 右键菜单

- **上下文菜单项**:
  - "跳转至向量表": 定位到表格中对应的单元格
- **跳转功能**:
  - 计算目标行所在的页码
  - 必要时切换到正确的页面
  - 高亮显示目标单元格并滚动到可见区域
  - 支持新旧两种视图

### 6.4 缩放与平移

- **水平缩放**:
  - 鼠标滚轮进行缩放
  - 仅X轴可缩放
  - 保持Y轴固定
- **平移**:
  - 鼠标拖拽平移视图
  - 仅允许水平平移
  - 保存缩放状态，在刷新后恢复

## 七、视觉呈现细节

### 7.1 波形线绘制

- **主波形线**:
  - 使用QCPGraph绘制
  - 线宽: 2.0
  - 颜色: 基于管脚索引分配
  - 线型: QCPGraph::lsStepLeft (数字信号阶梯线)

### 7.2 背景填充

- **偶数行填充**:
  - 蓝色交叉填充(QColor(0, 0, 255, 70))
  - 填充样式: Qt::DiagCrossPattern
- **奇数行填充**:
  - 紫色交叉填充(QColor(128, 0, 128, 70))
  - 填充样式: Qt::DiagCrossPattern

### 7.3 标记与标签

- **高亮标记**:
  - 蓝色虚线矩形(QPen(Qt::blue, 2, Qt::DotLine))
  - 半透明蓝色填充(QColor(0, 0, 255, 30))
- **值标签**:
  - 字体: Arial, 10pt, 粗体
  - 颜色: 蓝色
  - 背景: 半透明白色(QColor(255, 255, 255, 200))
  - 边框: 蓝色
  - 内边距: QMargins(4, 4, 4, 4)

### 7.4 图例配置

- **图例位置**: 右上角
- **图例字体**: Helvetica, 9pt (管脚数>8时减小到7pt)
- **图例背景**: 半透明白色(QColor(255, 255, 255, 230))
- **图例边框**: 无(Qt::NoPen)
- **默认可见性**: 关闭(legend->setVisible(false))

## 八、其他功能

### 8.1 布局适应

- **最小高度**: 默认200像素，但会根据管脚数量调整
- **自动调整**: 确保足够空间显示所有管脚波形

  ```cpp
  m_waveformPlot->setMinimumHeight(qMax(200, int(totalYRange) + 50));
  ```

### 8.2 刷新机制

- **显示切换时自动刷新**

  ```cpp
  void MainWindow::toggleWaveformView(bool show)
  {
      if (m_waveformDock)
      {
          m_waveformDock->setVisible(show);
          m_isWaveformVisible = show;
          if (show)
          {
              updateWaveformView();
          }
      }
  }
  ```

- **手动刷新按钮**
- **管脚选择变化时自动刷新**
- **"全部"勾选状态变化时自动刷新**

### 8.3 表格数据同步

- **从表格获取当前页修改后的数据**:

  ```cpp
  // 从模型或表格控件获取当前页的数据
  // 使用这些数据覆盖从数据处理器获取的基础数据
  ```

- **支持两种视图同步**:
  - 从新视图(m_vectorTableModel)同步
  - 从旧视图(m_vectorTableWidget)同步

### 8.4 波形缓存与性能优化

- 当前实现没有专门的缓存机制，每次更新都重新获取全部数据
- 针对大数据集无特殊优化，这是当前性能瓶颈

---

## 附录：关键方法与功能对照表

| 方法名 | 文件 | 功能描述 |
|-------|------|----------|
| setupWaveformView | mainwindow_waveform_view_1.cpp | 初始化波形图视图和组件 |
| updateWaveformView | mainwindow_waveform_view_1.cpp | 更新波形图显示内容 |
| toggleWaveformView | mainwindow_waveform_view_1.cpp | 控制波形图视图的显示/隐藏 |
| onWaveformPinSelectionChanged | mainwindow_waveform_view_1.cpp | 处理管脚选择变化 |
| onShowAllPinsChanged | mainwindow_waveform_view_1.cpp | 处理"全部"勾选框状态变化 |
| highlightWaveformPoint | mainwindow_waveform_view_2.cpp | 高亮显示指定的波形点 |
| setupWaveformClickHandling | mainwindow_waveform_view_2.cpp | 设置波形图的点击处理 |
| onWaveformDoubleClicked | mainwindow_waveform_view_2.cpp | 处理波形图双击事件 |
| onWaveformContextMenuRequested | mainwindow_waveform_view_3.cpp | 处理波形图右键菜单请求 |
| getWaveTypeAndT1F | mainwindow_waveform_types.cpp | 获取波形类型和T1F值 |
| getWaveTypeName | mainwindow_waveform_types.cpp | 获取波形类型名称 |
| applyWaveformPattern | mainwindow_waveform_types.cpp | 应用波形模式(NRZ, RZ, R0, SBC) |
| drawWaveformPatterns | mainwindow_waveform_types.cpp | 绘制特殊波形模式 |
| getTimeSetIdForRow | mainwindow_waveform_timeset.cpp | 获取行的TimeSet ID |
| getTimeSetT1RAndPeriod | mainwindow_waveform_timeset.cpp | 获取TimeSet的T1R值和周期 |
| getPinIdByName | mainwindow_waveform_timeset.cpp | 获取管脚ID |
