# 删除向量表功能实现说明

## 背景

在新轨道架构下，需要实现删除向量表的功能，以便用户能够移除不需要的向量表。这个功能需要确保正确删除所有相关的数据库记录和文件系统中的二进制文件。

## 实现方案

新轨道下的向量表删除功能由 `RobustVectorDataHandler::deleteVectorTable` 方法实现，该方法遵循以下步骤：

1. **获取二进制文件信息**：
   - 查询 `VectorTableMasterRecord` 表，获取表名和二进制文件名
   - 使用 `resolveBinaryFilePath` 方法解析完整的二进制文件路径

2. **删除数据库记录**：在事务中执行以下操作，确保数据一致性
   - 删除 `VectorTableRowIndex` 表中的行索引记录
   - 删除 `VectorTableColumnConfiguration` 表中的列配置记录
   - 删除 `VectorTableMasterRecord` 表中的主记录
   - **更新 `vector_tables` 表记录**：不直接删除记录，而是将表名重命名为一个带有时间戳和"_deleted"标记的唯一名称，释放原表名供将来使用

3. **删除二进制文件**：
   - 从文件系统中删除二进制数据文件
   - 即使文件删除失败，也不影响整体操作的结果

## 关键代码逻辑

1. **获取二进制文件路径**：

```cpp
// 查询二进制文件名和表名
QSqlQuery query(db);
query.prepare("SELECT binary_data_filename, table_name FROM VectorTableMasterRecord WHERE id = ?");
query.addBindValue(tableId);
if (!query.exec() || !query.next())
{
    // 处理错误...
}

// 解析完整路径
binFilePath = resolveBinaryFilePath(tableId, resolveError);
```

2. **删除数据库记录**：

```cpp
// 开启事务
db.transaction();

// 删除行索引记录
QSqlQuery deleteRowsQuery(db);
deleteRowsQuery.prepare("DELETE FROM VectorTableRowIndex WHERE master_record_id = ?");
deleteRowsQuery.addBindValue(tableId);
// 执行并检查结果...

// 删除列配置记录
QSqlQuery deleteColumnsQuery(db);
deleteColumnsQuery.prepare("DELETE FROM VectorTableColumnConfiguration WHERE master_record_id = ?");
// 执行并检查结果...

// 删除主记录
QSqlQuery deleteMasterQuery(db);
deleteMasterQuery.prepare("DELETE FROM VectorTableMasterRecord WHERE id = ?");
// 执行并检查结果...

// 更新vector_tables表记录以允许重用表名
QSqlQuery getTableNameQuery(db);
getTableNameQuery.prepare("SELECT table_name FROM vector_tables WHERE id = ?");
getTableNameQuery.addBindValue(tableId);
if (getTableNameQuery.exec() && getTableNameQuery.next())
{
    QString oldTableName = getTableNameQuery.value(0).toString();
    QString newTableName = QString("%1_deleted_%2").arg(oldTableName).arg(QDateTime::currentMSecsSinceEpoch());
    
    QSqlQuery updateTableNameQuery(db);
    updateTableNameQuery.prepare("UPDATE vector_tables SET table_name = ? WHERE id = ?");
    updateTableNameQuery.addBindValue(newTableName);
    updateTableNameQuery.addBindValue(tableId);
    // 执行并记录结果...
}

// 提交事务
db.commit();
```

3. **删除二进制文件**：

```cpp
// 从文件系统中删除二进制文件
QFile binFile(binFilePath);
if (binFile.exists())
{
    if (binFile.remove())
    {
        // 成功删除
    }
    else
    {
        // 记录警告，但不影响操作结果
    }
}
```

## 错误处理

1. **事务回滚**：
   - 如果在删除数据库记录过程中发生错误，会回滚事务，确保数据库一致性
   - 详细的错误信息会记录在日志中，并通过 `errorMessage` 参数返回给调用者

2. **文件删除失败**：
   - 如果二进制文件删除失败，只会记录警告日志，不会导致整个操作失败
   - 这样设计是因为数据库记录已经被删除或更新，即使文件残留也不会影响系统功能

## 改进方向

1. **数据备份**：可以考虑在删除前进行数据备份，方便用户恢复误删的数据
2. **回收站机制**：实现软删除机制，允许用户在一定时间内恢复删除的向量表
3. **批量删除**：支持批量删除多个向量表，提高效率
