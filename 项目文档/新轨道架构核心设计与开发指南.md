# AI代理开发手册：VecEdit"新轨道"架构

## 1. 任务目标

本手册为AI代理提供了一套**严格的、必须遵守的**规则和开发协议。在对本项目进行任何代码修改、功能添加或重构时，AI代理**必须**严格遵循本文档中定义的核心原则和操作规程。任何偏离本手册的行为都可能导致系统性能下降或数据损坏。

---

## 2. 核心架构原则 (AI必须遵守的最高准则)

AI在进行任何开发活动前，必须完全理解并遵循以下三大核心原则：

-   **原则一：索引与数据分离**
    -   **描述**：系统采用混合存储。SQLite数据库 (`.db`) **只用于**存储元数据和索引；所有原始行数据**必须**存储在二进制文件 (`.vbindata`) 中。
    -   **AI行为准则**：严禁在数据库中存储任何大规模的原始向量数据。严禁在二进制文件中存储任何索引或元数据。

-   **原则二：操作的逻辑化与延迟处理**
    -   **描述**：为了实现极致的性能，用户的操作（如删除、更新）应首先通过修改索引来完成"逻辑"上的变更。繁重的物理文件操作（如清理空间）**必须**被延迟到后台或特定维护任务中。
    -   **AI行为准则**：在实现用户功能时，应优先采用修改数据库索引的逻辑操作。禁止将耗时的文件重写等操作直接放入用户交互的同步流程中。

-   **原则三：单一数据源**
    -   **描述**：`RobustVectorDataHandler` 是与数据持久层交互的**唯一**合法接口。所有的数据流都必须遵循 `持久层 -> RobustVectorDataHandler -> 数据模型 -> UI` 的路径。
    -   **AI行为准准则**：严禁在UI层或项目的其他任何地方创建新的、并行的、绕过`RobustVectorDataHandler`的数据访问链路。

---

## 3. 数据模型契约 (AI不可违背的接口)

### 3.1 数据库表结构
AI必须基于以下表结构进行数据库操作：
-   **`VectorTableMasterRecord`**: 存储表的宏观信息，特别是 `row_count`（有效行总数）。
-   **`VectorTableColumnConfiguration`**: 定义列结构。`IsVisible` 字段是控制列可见性的**唯一**机制。
-   **`VectorTableRowIndex`**: 行级索引。
    -   `logical_row_order`: 定义用户所见的行序。
    -   `offset`, `size`: 定义了行数据在二进制文件中的物理位置。
    -   `is_active`: `1`为有效，`0`为逻辑删除。这是判断行是否存在的**唯一**标准。

### 3.2 二进制文件 (`.vbindata`)
-   此文件是一个纯粹的二进制数据"块"，AI**绝不能**假设其内部有任何特定结构，访问它**必须**通过 `VectorTableRowIndex` 中提供的 `offset` 和 `size`。

---

## 4. AI开发规程：核心数据操作 (CRUD)

在实现任何增删改查功能时，AI**必须**遵循以下规程：

### 4.1 创建 (Create / 添加行)
-   **调用接口**: `RobustVectorDataHandler::insertVectorRows`。
-   **执行规程**:
    1.  所有新行数据**必须**以追加模式(Append)写入到 `.vbindata` 文件的**末尾**。
    2.  新行在文件中的 `offset` 和 `size` **必须**被记录下来。
    3.  新行的索引信息**必须**以批量方式插入到 `VectorTableRowIndex` 表，并设置 `is_active = 1`。
    4.  若在中间插入，**必须**先通过 `UPDATE` 增加后续所有行的 `logical_row_order` 值，为新行腾出逻辑位置。

### 4.2 读取 (Read / 获取行)
-   **执行规程**:
    1.  **必须**首先查询 `VectorTableRowIndex` 表，并使用 `WHERE is_active = 1` 作为过滤条件。
    2.  根据 `logical_row_order` 找到目标行的索引记录。
    3.  使用该记录中的 `offset` 和 `size` 从 `.vbindata` 文件中进行精确读取。

### 4.3 删除 (Delete / 移除行)
-   **调用接口**: `RobustVectorDataHandler::deleteVectorRows`。
-   **执行规程**:
    1.  **绝对禁止**以任何形式修改 `.vbindata` 文件。
    2.  **必须**通过 `UPDATE` SQL语句，将 `VectorTableRowIndex` 表中目标行的 `is_active` 标志位设置为 `0`。
    3.  **必须**在 `VectorTableMasterRecord` 表中将 `row_count` 减去删除的行数。

### 4.4 更新 (Update / 修改行)
-   **调用接口**: `RobustVectorDataHandler::updateVectorRow`。
-   **执行规程**: AI**必须**实现"智能混合策略"：
    1.  计算新数据尺寸 `newSize` 和旧数据尺寸 `oldSize`。
    2.  **IF (`newSize <= oldSize`)**: **必须**在 `.vbindata` 文件的原始 `offset` 位置执行"原位更新"（覆写）。
    3.  **IF (`newSize > oldSize`)**: **必须**将新数据追加到 `.vbindata` 文件末尾。原物理空间作废，成为"垃圾"。
    4.  无论采用何种方式，最后都**必须** `UPDATE` `VectorTableRowIndex` 表中该行的 `offset` 和 `size` 为新值。

---

## 5. AI开发规程：批量操作 (如"填充向量")

-   **核心规则**: **绝对禁止**使用循环进行逐行操作。
-   **执行规程**:
    1.  在内存中构建所有待更新的行数据。
    2.  将这些数据一次性、批量地**追加**到 `.vbindata` 文件末尾。
    3.  在一个数据库事务中，通过一条或多条批量 `UPDATE` 语句，更新所有相关行在 `VectorTableRowIndex` 中的 `offset` 和 `size`，使其指向新的物理位置。

---

## 6. AI开发规程：管脚/列管理 (高危操作)

此功能极易出错，AI**必须**严格遵循以下"纯逻辑"规程。

-   **黄金法则**: 管脚/列的增、删、显、隐，是**纯粹的数据库逻辑操作**。
-   **绝对禁止**:
    -   **禁止**因隐藏或显示列而修改 `.vbindata` 文件。
    -   **禁止**因隐藏或显示列而修改 `.vbindata` 文件头中的任何信息（如列计数）。

-   **执行规程**:
    1.  所有操作的目标**仅为** `VectorTableColumnConfiguration` 表。
    2.  **隐藏/显示**: **必须**通过 `UPDATE` 该表中目标列的 `IsVisible` 标志位 (`0` 或 `1`) 来实现。
    3.  **添加新列**: **必须**通过 `INSERT` 一条新的列配置到该表中来实现。
    4.  **数据过滤**: AI必须认知到，`RobustVectorDataHandler` 的逻辑会在从二进制文件读取物理行数据后，于内存中根据 `IsVisible` 配置进行列的过滤。AI开发的功能必须依赖此机制，不得自行实现。

---

## 7. AI开发规程：垃圾回收 (GC / 维护任务)

-   **定位**: GC是一个独立的、低优先级的维护任务，**绝不能**与用户触发的常规操作同步执行。
-   **触发条件**: 手动触发、程序空闲或垃圾数据比例超阈值。
-   **执行规程**:
    1.  创建一份新的、临时的 `.vbindata` 文件。
    2.  遍历 `VectorTableRowIndex` 表中所有 `is_active = 1` 的记录。
    3.  根据索引，从**旧文件**中读取有效数据，顺序写入到**新文件**中。
    4.  在一个事务内，批量 `UPDATE` **所有有效行**的 `offset` 和 `size`，使其指向新文件中的位置。
    5.  使用新文件原子替换旧文件。

---

## 8. 总结：AI绝对禁止的行为清单

-   **禁止**在未查询索引的情况下直接读取二进制文件。
-   **禁止**为"删除行"操作去修改二进制文件。
-   **禁止**为"隐藏/显示列"操作去修改二进制文件或其文件头。
-   **禁止**在批量更新功能中使用逐行循环的读写模式。
-   **禁止**创建任何绕过 `RobustVectorDataHandler` 的新数据访问函数或路径。

本手册是AI代理执行任务的最高准则。在开始工作前，请再次确认已完全理解所有规程。 