# 管脚选择功能设计与实现说明

## 1. 功能概述

管脚选择功能是VecEdit软件中的核心功能之一，允许用户为向量表选择和配置管脚。该功能通过"管脚选择"对话框实现，使用户能够：

- 选择要在向量表中显示的管脚
- 设置管脚的类型（输入、输出或双向）
- 管理管脚与向量表的关联关系
- 控制管脚列的可见性

## 2. 数据结构与关系

### 2.1 相关数据库表

管脚选择功能涉及以下几个关键数据库表：

1. **`pin_list`表**：存储所有可用的管脚信息
   - `id`: 管脚ID
   - `pin_name`: 管脚名称
   - `pin_note`: 管脚说明
   - `pin_nav_note`: 导航说明
   - `is_placeholder`: 是否为占位管脚（0=实际管脚，1=占位管脚）

2. **`vector_table_pins`表**：存储向量表与管脚的关联关系
   - `table_id`: 向量表ID
   - `pin_id`: 管脚ID
   - `pin_type`: 管脚类型（1=输入，2=输出，3=双向）
   - `pin_channel_count`: 通道数量

3. **`VectorTableColumnConfiguration`表**：存储向量表列的配置信息
   - `master_record_id`: 向量表ID
   - `column_name`: 列名称
   - `column_type`: 列类型（如'PIN_STATE_ID'表示管脚列）
   - `IsVisible`: 是否可见（0=隐藏，1=可见）
   - 其他列配置信息...

### 2.2 数据关系

这三个表之间的关系如下：

- `pin_list`表中的管脚可以与多个向量表关联
- `vector_table_pins`表记录了哪些管脚与哪些向量表关联
- `VectorTableColumnConfiguration`表控制管脚列在向量表中的显示状态

## 3. 管脚选择逻辑

### 3.1 管脚勾选状态的决定因素

一个管脚在"管脚选择"对话框中是否被默认勾选，取决于以下两个核心条件：

1. **管脚已关联到向量表**：在`vector_table_pins`表中，存在将该管脚（`pin_id`）与当前向量表（`table_id`）关联的记录。

2. **管脚列是可见的**：
   - 对于新轨道（RobustVectorDataHandler）：`getAllColumnInfo()`返回的列信息中，该管脚对应的列`is_visible`为true。
   - 对于旧轨道：在`VectorTableColumnConfiguration`表中，该管脚对应的列的`IsVisible`字段为1。

### 3.2 管脚选择操作类型

用户在管脚选择对话框中可以执行以下操作：

1. **勾选新管脚**：将之前未选择的管脚添加到向量表中
2. **取消勾选管脚**：将之前选择的管脚从向量表中移除（设为不可见）
3. **不做任何改变**：保持原有选择

## 4. 管脚选择处理流程

### 4.1 初始状态

假设一个典型的初始状态：

- 最大插槽数：3（硬编码限制，后期可配置）
- 初始已选：管脚A、B（`IsVisible=1`）
- 可用插槽：1个占位管脚ph1（`IsVisible=0`）
- `vector_table_pins`表包含：`(table_id, pin_id_A)`、`(table_id, pin_id_B)`、`(table_id, pin_id_ph1)`

### 4.2 用户操作场景与处理逻辑

#### 场景一：无任何变化

- **用户操作**：打开对话框，未做任何更改，点击"确定"
- **处理逻辑**：
  - 检测到最终选择与初始选择相同，不执行任何数据库操作

#### 场景二：纯粹添加管脚

- **用户操作**：在原有选择基础上，勾选新的管脚C
- **处理逻辑**：
  1. 启动数据库事务
  2. 在`VectorTableColumnConfiguration`表中：
     - 找到占位管脚ph1对应的列
     - 将该列的`column_name`从ph1的名字更新为C的名字
     - 将`IsVisible`从0更新为1
  3. 在`vector_table_pins`表中：
     - 将`(table_id, pin_id_ph1)`记录更新为`(table_id, pin_id_C)`
  4. 提交事务

#### 场景三：纯粹移除管脚

- **用户操作**：取消勾选已选的管脚A
- **处理逻辑**：
  1. 启动数据库事务
  2. 在`VectorTableColumnConfiguration`表中：
     - 找到管脚A对应的列
     - 将`IsVisible`从1更新为0
     - `column_name`保持不变
  3. `vector_table_pins`表不做任何更改（管脚A仍然关联到该表）
  4. 提交事务

#### 场景四：替换操作（混合添加与移除）

- **用户操作**：取消勾选A，同时勾选新的管脚C
- **处理逻辑**：
  1. 启动事务
  2. 处理移除A：
     - `VectorTableColumnConfiguration`：将A所在行的`IsVisible`更新为0
     - `vector_table_pins`：无变化
  3. 处理新增C：
     - 为C寻找可用插槽，优先选择占位符ph1
     - `VectorTableColumnConfiguration`：将ph1所在行更新为C的信息（`column_name`和`IsVisible=1`）
     - `vector_table_pins`：将`(table_id, pin_id_ph1)`更新为`(table_id, pin_id_C)`
  4. 提交事务

#### 场景五：超出数量限制

- **用户操作**：尝试勾选超过3个管脚
- **处理逻辑**：
  - 检测到最终勾选数量超过限制（3个）
  - 弹出错误提示框
  - 不执行任何数据库操作

### 4.3 特殊情况处理

#### 情况A：无可用占位符时添加新管脚

当没有占位符可用，但有被隐藏的管脚列（`IsVisible=0`）时：

1. 寻找一个`IsVisible=0`的管脚列
2. 更新该列的`column_name`为新管脚的名称，并设置`IsVisible=1`
3. 更新`vector_table_pins`表中对应的记录

#### 情况B：重新勾选之前取消的管脚

当用户重新勾选之前取消勾选的管脚时：

1. 寻找该管脚对应的列（`IsVisible=0`但`column_name`匹配）
2. 将该列的`IsVisible`设置为1
3. 不需要更新`vector_table_pins`表

## 5. 数据安全与一致性

### 5.1 数据安全保障

- **事务处理**：所有数据库操作都在事务中执行，确保原子性
- **数据保留**：取消勾选管脚时，仅修改可见性，不删除数据
- **错误处理**：任何操作失败都会回滚事务，保持数据一致性

### 5.2 向量数据保护

当用户取消勾选管脚A，然后再重新勾选时：

- 管脚A列的所有单元格值完全不会被改变
- 因为操作只修改了元数据（列配置和可见性），不触及实际的向量数据

## 6. 实现注意事项

### 6.1 核心原则

1. **关注最终状态**：处理逻辑应该只关心对话框打开时的"初始状态"和点击"确定"时的"最终状态"，而不是中间用户来回点击的步骤。

2. **插槽所有权**：`vector_table_pins`表反映了"插槽所有权"，只有在插槽所有权真正转移时（如从占位符转为实际管脚）才需要更新。

3. **硬限制**：当前硬编码限制为3个管脚，后期可能会改为用户可配置。

### 6.2 优化建议

1. **预加载数据**：对话框打开时预加载所有必要数据，减少数据库查询次数

2. **批量更新**：使用批量SQL语句更新多行数据，提高性能

3. **错误提示**：提供清晰的错误提示，特别是在超出限制时

## 7. 结论

管脚选择功能是一个看似简单但实际复杂的功能，它涉及多个数据库表之间的关系和状态管理。通过明确的处理逻辑和严格的数据一致性保障，可以确保用户操作的可靠性和数据的安全性。本文档详细说明了各种操作场景下的处理逻辑，为开发和维护提供了清晰的指导。
